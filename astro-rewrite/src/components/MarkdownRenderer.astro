---
import { marked } from 'marked';

export interface Props {
  content: string;
  class?: string;
}

const { content, class: className = '' } = Astro.props;

// Configure marked options
marked.setOptions({
  gfm: true,
  breaks: true,
});

// Custom renderer for links and images
const renderer = new marked.Renderer();

renderer.link = function(token: any): string {
  const { href, title, text } = token;
  const isExternal = href && (href.startsWith('http') || href.startsWith('//'));
  const titleAttr = title ? ` title="${title}"` : '';
  
  if (isExternal) {
    return `<a href="${href}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
  }
  
  return `<a href="${href}"${titleAttr}>${text}</a>`;
};

renderer.image = function(token: any): string {
  const { href, title, text } = token;
  
  // Parse size specifications from alt text
  let altText = text || '';
  let styleFromAlt = '';
  
  // Look for size specifications in alt text like "Description {width: 300px; height: 200px}"
  const sizeMatch = altText.match(/^(.*?)\s*\{([^}]+)\}\s*$/);
  if (sizeMatch) {
    altText = sizeMatch[1].trim();
    const styleSpecs = sizeMatch[2].trim();
    
    // Validate that it contains CSS-like properties
    if (styleSpecs.match(/\b(width|height|max-width|max-height|float|margin|padding|border-radius)\s*:\s*[^;]+/)) {
      styleFromAlt = styleSpecs;
    }
  }
  
  let imgTag = `<img src="${href}" alt="${altText}"`;
  
  // Handle style from alt text first (higher priority)
  if (styleFromAlt) {
    imgTag += ` style="${styleFromAlt}"`;
  } else if (title) {
    // Check if title contains style information (from Strapi)
    if (title.includes('width:') || title.includes('height:') || title.includes('float:')) {
      imgTag += ` style="${title}"`;
    } else {
      imgTag += ` title="${title}"`;
    }
  }
  
  imgTag += ' />';
  return imgTag;
};

marked.use({ renderer });

const processedContent = marked(content || '');
---

<div class={`markdown-content ${className}`} set:html={processedContent} />
